name: Windows

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
      - name: Cache vcpkg
        uses: actions/cache@v3
        id: vcpkg-cache
        with:
          path: |
            vcpkg
            !vcpkg/.git
            !vcpkg/downloads
            !vcpkg/buildtrees
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json') }}-v2
      - name: Setup vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git
          cd vcpkg
          ./bootstrap-vcpkg.bat
          ./vcpkg integrate install
          ./vcpkg install `
            boost-program-options:x64-windows `
            boost-system:x64-windows `
            boost-thread:x64-windows `
            boost-test:x64-windows `
            boost-interprocess:x64-windows `
            boost-ptr-container:x64-windows
          echo "VCPKG_ROOT=$PWD" >> $env:GITHUB_ENV
      - name: cmake
        run: |
          cmake -S . -B build `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_CXX_STANDARD=11 `
            -DCMAKE_CXX_STANDARD_REQUIRED=ON `
            -DCMAKE_CXX_FLAGS="/W3 /wd4267 /wd4244 /EHsc /bigobj" `
            -DCMAKE_VERBOSE_MAKEFILE=ON
      - name: Build with diagnostics
        run: |
          Write-Host "Starting build..."
          try {
            cmake --build build --config Release --parallel 2 --verbose
          }
          catch {
            Write-Host "Build failed with error: $_"
            Write-Host "Checking for log files..."

            # List all log files
            Get-ChildItem -Path build -Filter *.log -Recurse | ForEach-Object {
              Write-Host "`n=== $($_.FullName) ===`n"
              Get-Content $_.FullName -Tail 50
            }

            # Check for specific build errors
            $buildLog = Get-ChildItem -Path build -Filter "*.log" -Recurse | Select-Object -First 1
            if ($buildLog) {
              $content = Get-Content $buildLog.FullName
              if ($content -match "fatal error") {
                Write-Host "`nFatal errors found:"
                $content | Select-String "fatal error" | ForEach-Object { Write-Host $_ }
              }
            }

            throw
          }

      - name: Test
        working-directory: build
        run: ctest -j2
